name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: [push]
jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v5

  notification:
    needs: Explore-GitHub-Actions
    runs-on: ubuntu-latest
    env:
      webhook_url: "https://chat.googleapis.com/v1/spaces/AAQAoL3O840/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=iqBfBelvIk5ZaQ55RhdOTR0s-IwkOVm_ZCsD23SWsbk"
    steps:
      - run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{"text": "This is a msg from github"}' \
          "${{ env.webhook_url }}"

  build_docker_image:
    needs: notification
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v5

      - name: sonarqube scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Log in to Docker GitHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        uses: docker/build-push-action@v6
        with:
          push: false
          tags: rohitdarekar816/gitcommits:git
      
      - name: compress docker image
        run: docker run --rm -v /var/run/docker.sock:/var/run/docker.sock dslim/slim build --env "MONGO_URL=mongodb+srv://myAtlasDBUser:Rohit2023@github-webhook.p0pdz5y.mongodb.net/?retryWrites=true&w=majority&appName=Github-Webhook" rohitdarekar816/gitcommits:git
      
      - name: rename docker image
        run: docker tag rohitdarekar816/gitcommits.slim ghcr.io/rohitdarekar816/webhook-repo:git
    
      - name: scan docker image via trivy
        run: docker run -v /var/run/docker.sock:/var/run/docker.sock -v $HOME/Library/Caches:/root/.cache/ aquasec/trivy:0.67.0 image ghcr.io/rohitdarekar816/webhook-repo:git

      - name: login to github GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
  
      - name: push image to ghcr
        run: docker push ghcr.io/rohitdarekar816/webhook-repo:git

  post_success_notification:
    needs: build_docker_image
    runs-on: ubuntu-latest
    env:
      webhook_url: "https://chat.googleapis.com/v1/spaces/AAQAoL3O840/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=iqBfBelvIk5ZaQ55RhdOTR0s-IwkOVm_ZCsD23SWsbk"
    steps:
      - run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{"text": "Github action run success and push to image to github container registery"}' \
          "${{ env.webhook_url }}"
